---
Generated: 2025-01-23
Ticket Number: 19
---

# Refactorisation du code existant

- Type: Task
- Priority: Medium
- Story Points: 5
- Labels: refactoring, code-quality, drv, performance, auth
- Git Branch: `feat/workbench-19-refactor-code`

## Description

Refactoriser le code existant pour améliorer la qualité, réduire la duplication, optimiser les performances et gérer correctement tous les cas d'erreurs et d'authentification. Cette refactorisation couvre les repositories, la gestion d'erreurs, l'authentification et les optimisations de performance.

## User Story

En tant que développeur, je veux que le code soit refactorisé pour qu'il soit plus maintenable, performant et robuste, afin de faciliter les futures évolutions et réduire les bugs.

## Acceptance Criteria

- [ ] **Vérification des emplacements des fichiers**
  - [ ] Vérifier si les fichiers repositories sont aux bons emplacements selon l'architecture Clean Architecture
  - [ ] Décider d'une approche unique : utiliser uniquement les factories ou les repositories directs, éviter la duplication
  - [ ] Documenter la décision et la structure choisie

- [ ] **Réduction de la duplication de code (DRY)**
  - [ ] Extraire le code dupliqué entre `authRepositorySupabase.ts` et `authRepositorySupabaseFactory.ts` en fonctions utilitaires partagées
  - [ ] Extraire le code dupliqué entre `projectRepositorySupabase.ts` et `projectRepositorySupabaseFactory.ts`
  - [ ] Créer une fonction utilitaire pour le pattern de gestion d'erreurs répétitif dans tous les repositories (try/catch avec vérification de codes d'erreur)
  - [ ] Standardiser l'utilisation de `hasErrorCode` dans tous les repositories (actuellement incohérent : ticketRepository fait la vérification inline, projectRepository utilise `hasErrorCode`)

- [ ] **Amélioration de la gestion des erreurs**
  - [ ] Uniformiser la gestion des erreurs dans tous les repositories
  - [ ] Extraire la liste des codes d'erreur auth hardcodée (répétée 4 fois dans `authRepositorySupabase.ts`) en constante partagée
  - [ ] Vérifier que tous les cas d'erreurs sont bien gérés (notamment les erreurs de contraintes, erreurs réseau, erreurs d'authentification)
  - [ ] S'assurer que les erreurs sont mappées correctement vers les erreurs du domaine

- [ ] **Optimisation des performances**
  - [ ] Optimiser `addCurrentUserAsMember` dans les repositories de projets pour réduire les appels multiples (actuellement : `getSession()` + `rpc('project_exists')` + `findById()` = 3 appels)
  - [ ] Vérifier les autres méthodes qui font plusieurs appels get() et optimiser si nécessaire
  - [ ] Examiner les requêtes de list() dans les repositories pour s'assurer qu'elles sont optimisées

- [ ] **Gestion du cas d'authentification avec email de vérification**
  - [ ] Modifier `signUp` dans les repositories d'authentification pour gérer le cas où `data.session` est `null` après un signup réussi (cas où Supabase envoie un email de vérification)
  - [ ] Retourner un résultat approprié indiquant que l'email de vérification a été envoyé au lieu de lancer une erreur
  - [ ] Adapter le usecase `signUpUser` pour gérer ce nouveau cas
  - [ ] Mettre à jour l'UI de signup pour afficher un message approprié lorsque l'email de vérification est requis
  - [ ] Ajouter un type `AuthResult` avec un flag `requiresEmailVerification` si nécessaire

## Technical Considerations

- **Domain**:
  - Possible ajout d'un type `AuthResult` étendu pour gérer le cas de vérification d'email
  - Vérifier que les erreurs du domaine sont bien typées et cohérentes

- **Usecases**:
  - Adapter `signUpUser` pour gérer le nouveau cas de vérification d'email
  - S'assurer que tous les usecases gèrent correctement les erreurs du domaine

- **Infrastructure**:
  - Créer des fonctions utilitaires pour réduire la duplication dans les repositories
  - Créer un helper `handleRepositoryError` pour standardiser la gestion d'erreurs
  - Créer des constantes partagées pour les codes d'erreur
  - Optimiser les requêtes dans les repositories (notamment `addCurrentUserAsMember`)
  - Décider de l'architecture : utiliser uniquement les factories ou unifier les deux approches

- **Presentation**:
  - Mettre à jour `SignupPage` pour gérer le cas de vérification d'email requis
  - Adapter les hooks React Query si nécessaire (ex: `useSignUp`)

## Definition of Done

- [ ] Tous les tests existants passent
- [ ] Nouveaux tests ajoutés pour les cas de vérification d'email
- [ ] Tests pour les nouvelles fonctions utilitaires créées
- [ ] Code review effectué
- [ ] Aucune duplication majeure dans les repositories
- [ ] Tous les repositories utilisent la même approche de gestion d'erreurs
- [ ] Les performances sont optimisées (réduction des appels multiples)
- [ ] Le cas de vérification d'email est géré correctement
- [ ] Documentation mise à jour si nécessaire (architecture des repositories)

## Related Components

- `src/infrastructure/supabase/repositories/authRepositorySupabase.ts`
- `src/infrastructure/supabase/repositories/authRepositorySupabaseFactory.ts`
- `src/infrastructure/supabase/repositories/projectRepositorySupabase.ts`
- `src/infrastructure/supabase/repositories/projectRepositorySupabaseFactory.ts`
- `src/infrastructure/supabase/repositories/ticketRepositorySupabase.ts`
- `src/infrastructure/supabase/utils/errorMapper.ts`
- `src/shared/utils/guards.ts`
- `src/core/usecases/auth/signUpUser.ts`
- `src/presentation/hooks/useSignUp.ts`
- `src/app/signup/page.tsx`
- `src/core/domain/auth/auth.schema.ts`
